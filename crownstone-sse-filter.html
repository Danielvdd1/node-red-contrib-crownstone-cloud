<script type="text/javascript">
    RED.nodes.registerType('crownstone sse filter', {
        category: 'Crownstone',
        color: '#FFFFFF',
        defaults: {
            name: { value: "" },
            eventType: { value: "0", required: true }, // 1:presence, 2:swith // TODO replace string numbers with words?
            enterExit: { value: "" }, // "", "enter", "exit"
            sphereId1: { value: "" },
            locationId: { value: "" },
            userId: { value: "" },
            sphereId2: { value: "" },
            crownstoneId: { value: "" }
        },
        inputs: 1,
        outputs: 1,
        icon: "icons/crownstone_logo_black.svg",
        label: function () {
            return this.name || "Crownstone SSE filter"; // TODO: change name based on the event type
        },
        oneditprepare: function () {
            var node = this;

            function showEventProperties(eventType) {
                switch (eventType) {
                    case "1":
                        $("#section-1").show();
                        $("#section-2").hide();
                        break;

                    case "2":
                        $("#section-1").hide();
                        $("#section-2").show();
                        break;

                    default:
                        $("#section-1").hide();
                        $("#section-2").hide();
                        break;
                }
            }

            // Show the event properties of the selected event type
            if ($('#node-input-eventType').val()) {
                let eventType = $('#node-input-eventType').val();
                showEventProperties(eventType);
            }
            // Show the event properties of the event type when the type is selected
            $('#node-input-eventType').on("change", function () {
                let eventType = $('#node-input-eventType').val();
                showEventProperties(eventType);
            });


            function updateSection1() {

                function updateLocationList() {
                    $.getJSON('locations/' + node.id, function (data) {
                        // Generate drop-down list
                        $('#node-input-locationName').empty();
                        $('#node-input-locationName').append(`<option value="">All</option>`);
                        for (let location of data) {
                            $('#node-input-locationName').append(`<option value="${location.id}" title="${location.sphereName}">${location.name}</option>`);
                        }
                        // Highlight selected item
                        $('#node-input-locationName').val($('#node-input-locationId').val());
                    });
                }

                function updateUserList(sphereId) {
                    if (sphereId === "") { // Request not possible when all spheres are selected
                        return;
                    }
                    $.getJSON('users/' + node.id + '/' + sphereId, function (data) {
                        // Generate drop-down list
                        $('#node-input-userName').empty();
                        $('#node-input-userName').append(`<option value="">All</option>`);
                        for (let user of data) {
                            $('#node-input-userName').append(`<option value="${user.id}" title="${user.firstName} ${user.lastName}">${user.firstName}</option>`);
                        }
                        // Highlight selected item
                        $('#node-input-userName').val($('#node-input-userId').val());
                    });
                }

                $.getJSON('spheres/' + node.id, function (data) {
                    // Generate drop-down list
                    for (let sphere of data) {
                        $('#node-input-sphereName1').append(`<option value="${sphere.id}">${sphere.name}</option>`);
                    }
                    // Highlight selected item
                    $('#node-input-sphereName1').val($('#node-input-sphereId1').val());

                    if ($('#node-input-sphereId1').val()) {
                        let sphereId = $('#node-input-sphereId1').val();
                        updateUserList(sphereId);
                    }
                })/*.fail(function (jqXHR, textStatus, errorThrown) {
                    if (jqXHR.status === 400) {
                        // Show the tip to Deploy the code
                        $('#tip-deploy').show();
                    }
                    else if (jqXHR.status === 401) {
                        // Show the tip to add the Crownstone authenticate node
                        $('#tip-authenticate').show();
                    }
                })*/;

                updateLocationList();

                // Generate user list when a sphere is selected
                $('#node-input-sphereName1').on("change", function () {
                    let sphereId = $('#node-input-sphereName1').val();
                    updateUserList(sphereId);
                });
            }

            function updateSection2() {

                $.getJSON('crownstones/' + node.id, function (data) {
                    // Generate drop-down list
                    $('#node-input-crownstoneName').empty();
                    $('#node-input-crownstoneName').append(`<option value="">All</option>`);
                    for (let crownstone of data) {
                        $('#node-input-crownstoneName').append(`<option value="${crownstone.id}" title="${crownstone.location}">${crownstone.name}</option>`);
                    }
                    // Highlight selected item
                    $('#node-input-crownstoneName').val($('#node-input-crownstoneId').val());
                });

                $.getJSON('spheres/' + node.id, function (data) {
                    // Generate drop-down list
                    for (let sphere of data) {
                        $('#node-input-sphereName2').append(`<option value="${sphere.id}">${sphere.name}</option>`);
                    }
                    // Highlight selected item
                    $('#node-input-sphereName2').val($('#node-input-sphereId2').val());

                })/*.fail(function (jqXHR, textStatus, errorThrown) {
                    if (jqXHR.status === 400) {
                        // Show the tip to Deploy the code
                        $('#tip-deploy').show();
                    }
                    else if (jqXHR.status === 401) {
                        // Show the tip to add the Crownstone authenticate node
                        $('#tip-authenticate').show();
                    }
                })*/;

                updateCrownstoneList();

                // Generate user list when a sphere is selected
                $('#node-input-sphereName2').on("change", function () {
                    let sphereId = $('#node-input-sphereName2').val();
                    updateCrownstoneList();
                });
            }

            updateSection1();
            updateSection2();
        },
        oneditsave: function () {
            // Put the chosen sphere in the hidden field
            $('#node-input-sphereId1').val($('#node-input-sphereName1').val());
            // Put the chosen location in the hidden field
            $('#node-input-locationId').val($('#node-input-locationName').val());
            // Put the chosen user in the hidden field
            $('#node-input-userId').val($('#node-input-userName').val());

            // Put the chosen sphere in the hidden field
            $('#node-input-sphereId2').val($('#node-input-sphereName2').val());
            // Put the chosen Crownstone in the hidden field
            $('#node-input-crownstoneId').val($('#node-input-crownstoneName').val());
        }
    });
</script>

<script type="text/html" data-template-name="crownstone sse filter">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>

    <div class="form-row form-row-eventType" id="input-eventType">
        <label for="node-input-eventType"><i class="fa fa-bell"></i> Event type</label>
        <select type="text" id="node-input-eventType" style="width: 250px;">
            <option value="0">Select event type</option>
            <option value="1">Presence event</option>
            <option value="2">Switch event</option>
        </select>
    </div>

    <div id="section-1" hidden>
        <div class="form-row form-row-enterExit" id="input-enterExit">
            <label for="node-input-enterExit"><i class="fa fa-sign-out"></i> Enter/Exit</label>
            <select type="text" id="node-input-enterExit" style="width: 250px;">
                <option value="">Enter or exit</option>
                <option value="enter">Enter</option>
                <option value="exit">Exit</option>
            </select>
        </div>

        <div class="form-row form-row-sphereId1" id="input-sphereId1" hidden>
            <input type="text" id="node-input-sphereId1">
        </div>
        <div class="form-row form-row-sphereName1" id="input-sphereName1">
            <label for="node-input-sphereName1"><i class="fa fa-circle-o"></i> Sphere</label>
            <select type="text" id="node-input-sphereName1" style="width: 250px;">
                <option value="">All</option>
            </select>
        </div>

        <div class="form-row form-row-locationId" id="input-locationId" hidden>
            <input type="text" id="node-input-locationId">
        </div>
        <div class="form-row form-row-locationName">
            <label for="node-input-locationName"><i class="fa fa-map-marker"></i> Location</label>
            <select type="text" id="node-input-locationName" style="width: 250px;">
                <option value="">All</option>
            </select>
        </div>
    
        <div class="form-row form-row-userId" id="input-userId" hidden>
            <input type="text" id="node-input-userId">
        </div>
        <div class="form-row form-row-userName" id="input-userName">
            <label for="node-input-userName"><i class="fa fa-user"></i> Username</label>
            <select type="text" id="node-input-userName" style="width: 250px;">
                <option value="">All</option>
            </select>
        </div>
    </div>

    <div id="section-2" hidden>
        <div class="form-row form-row-sphereId2" id="input-sphereId2" hidden>
            <input type="text" id="node-input-sphereId2">
        </div>
        <div class="form-row form-row-sphereName2" id="input-sphereName2">
            <label for="node-input-sphereName2"><i class="fa fa-circle-o"></i> Sphere</label>
            <select type="text" id="node-input-sphereName2" style="width: 250px;">
                <option value="">All</option>
            </select>
        </div>

        <div class="form-row form-row-crownstoneId" id="input-crownstoneId" hidden>
            <input type="text" id="node-input-crownstoneId">
        </div>
        <div class="form-row form-row-crownstoneName">
            <label for="node-input-crownstoneName"><i class="fa fa-plug"></i> Crownstone name</label>
            <select type="text" id="node-input-crownstoneName" style="width: 250px;">
                <option value="">All</option>
            </select>
        </div>
    </div>


    <!-- <div class="form-tips" id="tip-authenticate" hidden><b>Tip:</b> Add the Crowsntone authenticate node to the flow to authenticate the user and make use of this node.</div>
    <div class="form-tips" id="tip-deploy" hidden><b>Tip:</b> Deploy the flow first before the list can be created.</div> -->
</script>

<script type="text/html" data-help-name="crownstone sse filter">
    <p>Filters events from the Crownstone SSE client node.</p>

    TODO: Add instructions
</script>